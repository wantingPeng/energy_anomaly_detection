# LSTM-CNN æ¨¡å‹è°ƒå‚è¯´æ˜

## é’ˆå¯¹å½“å‰é—®é¢˜çš„ä¼˜åŒ–æ–¹æ¡ˆ

### å½“å‰é—®é¢˜è¯Šæ–­

æ‚¨çš„æŒ‡æ ‡ï¼š
- **Adjusted F1**: 0.1867 âŒ
- **Precision**: 0.1135 âŒ (è¯¯æŠ¥ç‡æé«˜)
- **Recall**: 0.5246 âš ï¸ (æ¼æ£€ç‡è¾ƒé«˜)

**é—®é¢˜åˆ†æ**ï¼š
1. Precision å¤ªä½ â†’ æ¨¡å‹é¢„æµ‹äº†å¤§é‡è¯¯æŠ¥
2. Recall ä¸­ç­‰ â†’ æ¨¡å‹èƒ½æ£€æµ‹åˆ°çº¦ä¸€åŠçš„çœŸå®å¼‚å¸¸
3. æ€»ä½“ F1 å¾ˆä½ â†’ æ¨¡å‹æ€§èƒ½ä¸ä½³

### å·²å®Œæˆçš„è°ƒå‚ä¼˜åŒ–

æˆ‘å·²ç»å¯¹é…ç½®æ–‡ä»¶ `configs/lstm_cnn_config.yaml` è¿›è¡Œäº†ä»¥ä¸‹ä¼˜åŒ–ï¼š

#### 1. æ•°æ®é…ç½®ä¼˜åŒ–

```yaml
# ä¹‹å‰ â†’ ä¼˜åŒ–å
window_size: 60  â†’ 120   # æä¾›æ›´å¤šä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆ2å°æ—¶ï¼‰
step_size: 10    â†’ 5     # æ›´å¤šé‡å ï¼Œç”Ÿæˆæ›´å¤šè®­ç»ƒæ ·æœ¬
target_anomaly_ratio: 0.25 â†’ 0.20  # æ›´å¹³è¡¡çš„æ­£è´Ÿæ ·æœ¬æ¯”ä¾‹
```

**åŸå› **ï¼š
- æ›´å¤§çš„çª—å£æ•è·æ›´é•¿æœŸçš„æ—¶åºæ¨¡å¼
- æ›´å°çš„æ­¥é•¿å¢åŠ è®­ç»ƒæ ·æœ¬æ•°é‡
- é€‚åº¦çš„å¼‚å¸¸æ¯”ä¾‹é¿å…è¿‡åº¦å¹³è¡¡å¯¼è‡´æ¨¡å‹åå‘

#### 2. æ¨¡å‹å®¹é‡ä¼˜åŒ–

```yaml
# ä¹‹å‰ â†’ ä¼˜åŒ–å
cnn_channels: [64, 128, 128] â†’ [128, 256, 256, 128]
cnn_kernel_sizes: [3, 3, 3]  â†’ [3, 5, 3, 3]  # å¤šå°ºåº¦å·ç§¯
lstm_hidden_dim: 128 â†’ 256
lstm_num_layers: 2 â†’ 3
dropout: 0.3 â†’ 0.2  # å‡å°‘dropoutï¼Œé¿å…æ¬ æ‹Ÿåˆ
```

**åŸå› **ï¼š
- å¢å¤§æ¨¡å‹å®¹é‡å­¦ä¹ æ›´å¤æ‚çš„å¼‚å¸¸æ¨¡å¼
- å¤šå°ºåº¦å·ç§¯æ ¸æ•è·ä¸åŒç²’åº¦çš„ç‰¹å¾
- é™ä½dropoutå› ä¸ºæ¨¡å‹å¯èƒ½æ¬ æ‹Ÿåˆ

#### 3. è®­ç»ƒç­–ç•¥ä¼˜åŒ–

```yaml
# ä¹‹å‰ â†’ ä¼˜åŒ–å
batch_size: 64 â†’ 32           # æ›´é¢‘ç¹çš„å‚æ•°æ›´æ–°
num_epochs: 100 â†’ 150         # æ›´å……åˆ†çš„è®­ç»ƒ
optimizer: "adam" â†’ "adamw"   # æ›´å¥½çš„æ­£åˆ™åŒ–
learning_rate: 0.001 â†’ 0.0005 # æ›´ç¨³å®šçš„è®­ç»ƒ
weight_decay: 0.0001 â†’ 0.0005 # æ›´å¼ºçš„æ­£åˆ™åŒ–
```

#### 4. æŸå¤±å‡½æ•°ä¼˜åŒ–ï¼ˆæœ€é‡è¦ï¼ï¼‰

```yaml
# ä¹‹å‰ â†’ ä¼˜åŒ–å
focal_loss_alpha: 0.75 â†’ 0.85  # æ›´å¼ºè°ƒå¼‚å¸¸ç±»åˆ«
focal_loss_gamma: 2.0 â†’ 2.5    # æ›´å…³æ³¨éš¾åˆ†ç±»æ ·æœ¬
early_stopping_metric: "optimal_f1" â†’ "adj_f1"  # æ›´å®é™…çš„è¯„ä¼°æŒ‡æ ‡
```

**åŸå› **ï¼š
- æ›´é«˜çš„ alpha ç»™å¼‚å¸¸ç±»æ›´å¤§æƒé‡ï¼Œå‡å°‘è¯¯æŠ¥
- æ›´é«˜çš„ gamma è®©æ¨¡å‹ä¸“æ³¨äºéš¾åˆ†ç±»æ ·æœ¬
- ä½¿ç”¨ adjusted F1 ä½œä¸ºåœæ­¢æ ‡å‡†æ›´ç¬¦åˆå®é™…åº”ç”¨

---

## å¦‚ä½•ä½¿ç”¨ Model Variants

ç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨é¢„è®¾çš„æ¨¡å‹é…ç½®ï¼æˆ‘å·²ç»ä¿®æ”¹äº†è®­ç»ƒè„šæœ¬æ”¯æŒ `--model_variant` å‚æ•°ã€‚

### ä¸‰ç§é¢„è®¾é…ç½®

#### 1. **Lightweight** - è½»é‡çº§ï¼ˆå¿«é€Ÿå®éªŒï¼‰
```bash
python src/training/lstm_cnn/train_lstm_cnn.py --model_variant lightweight
```
- å‚æ•°å°‘ï¼Œè®­ç»ƒå¿«
- é€‚åˆå¿«é€Ÿæµ‹è¯•å’Œè°ƒè¯•
- CNN: 32 channels, LSTM: 32 hidden

#### 2. **Standard** - æ ‡å‡†ï¼ˆæ¨èé»˜è®¤ï¼‰
```bash
python src/training/lstm_cnn/train_lstm_cnn.py --model_variant standard
```
- å¹³è¡¡æ€§èƒ½å’Œé€Ÿåº¦
- é€‚åˆå¤§å¤šæ•°åœºæ™¯
- CNN: [64,128,128], LSTM: 128 hidden

#### 3. **Large** - å¤§å‹ï¼ˆæœ€ä½³æ€§èƒ½ï¼‰
```bash
python src/training/lstm_cnn/train_lstm_cnn.py --model_variant large
```
- æœ€å¼ºæ€§èƒ½ï¼Œéœ€è¦æ›´å¤šè®¡ç®—èµ„æº
- é€‚åˆå……è¶³èµ„æºå’Œè¿½æ±‚æœ€ä½³æ•ˆæœ
- CNN: [128,256,256,256], LSTM: 256 hidden

### å®Œæ•´è®­ç»ƒå‘½ä»¤ç¤ºä¾‹

```bash
# æ¿€æ´»ç¯å¢ƒ
cd /home/wanting/energy_anomaly_detection
source venv/bin/activate

# æ–¹å¼1ï¼šä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆå·²ä¼˜åŒ–çš„é…ç½®ï¼‰
python src/training/lstm_cnn/train_lstm_cnn.py

# æ–¹å¼2ï¼šä½¿ç”¨è½»é‡çº§æ¨¡å‹å¿«é€Ÿæµ‹è¯•
python src/training/lstm_cnn/train_lstm_cnn.py \
    --model_variant lightweight \
    --experiment_name lstm_cnn_light_test

# æ–¹å¼3ï¼šä½¿ç”¨å¤§å‹æ¨¡å‹è¿½æ±‚æœ€ä½³æ€§èƒ½
python src/training/lstm_cnn/train_lstm_cnn.py \
    --model_variant large \
    --experiment_name lstm_cnn_large_exp1

# æ–¹å¼4ï¼šè‡ªå®šä¹‰é…ç½®æ–‡ä»¶
python src/training/lstm_cnn/train_lstm_cnn.py \
    --config configs/lstm_cnn_config.yaml \
    --experiment_name my_experiment
```

---

## è¿›ä¸€æ­¥è°ƒå‚å»ºè®®

### å¦‚æœ Precision ä»ç„¶å¾ˆä½ï¼ˆè¯¯æŠ¥å¤šï¼‰

1. **å¢å¤§ focal_loss_alpha**:
   ```yaml
   focal_loss_alpha: 0.9  # ç”šè‡³ 0.95
   ```

2. **å¢å¤§é˜ˆå€¼ä¼˜åŒ–çš„å€¾å‘**:
   åœ¨è®­ç»ƒåæ‰‹åŠ¨è°ƒæ•´é¢„æµ‹é˜ˆå€¼ï¼Œåå‘æ›´ä¿å®ˆçš„å¼‚å¸¸æ£€æµ‹

3. **å¢åŠ  weight_decay**:
   ```yaml
   weight_decay: 0.001  # æ›´å¼ºæ­£åˆ™åŒ–
   ```

### å¦‚æœ Recall ä»ç„¶å¾ˆä½ï¼ˆæ¼æ£€å¤šï¼‰

1. **å‡å° focal_loss_alpha**:
   ```yaml
   focal_loss_alpha: 0.6  # è®©æ¨¡å‹æ›´æ•æ„Ÿ
   ```

2. **å¢å¤§è®­ç»ƒæ•°æ®ä¸­çš„å¼‚å¸¸æ¯”ä¾‹**:
   ```yaml
   target_anomaly_ratio: 0.3
   ```

3. **å¢å¤§çª—å£å¤§å°**:
   ```yaml
   window_size: 180  # 3å°æ—¶
   ```

### å¦‚æœæ¨¡å‹è¿‡æ‹Ÿåˆï¼ˆè®­ç»ƒå¥½ä½†éªŒè¯å·®ï¼‰

1. **å¢å¤§ dropout**:
   ```yaml
   dropout: 0.4
   ```

2. **å¢å¤§ weight_decay**:
   ```yaml
   weight_decay: 0.001
   ```

3. **ä½¿ç”¨æ•°æ®å¢å¼º** (éœ€è¦ä¿®æ”¹ä»£ç )

### å¦‚æœæ¨¡å‹æ¬ æ‹Ÿåˆï¼ˆè®­ç»ƒå’ŒéªŒè¯éƒ½å·®ï¼‰

1. **å¢å¤§æ¨¡å‹å®¹é‡**:
   ```yaml
   cnn_channels: [256, 512, 512, 256]
   lstm_hidden_dim: 512
   lstm_num_layers: 4
   ```

2. **å‡å° dropout**:
   ```yaml
   dropout: 0.1
   ```

3. **å¢åŠ è®­ç»ƒè½®æ•°**:
   ```yaml
   num_epochs: 200
   ```

---

## ç›‘æ§è®­ç»ƒ

ä½¿ç”¨ TensorBoard å®æ—¶ç›‘æ§ï¼š

```bash
tensorboard --logdir experiments/lstm_cnn/tensorboard
```

å…³æ³¨æŒ‡æ ‡ï¼š
- `val/adj_f1` - è°ƒæ•´åçš„ F1ï¼ˆæœ€é‡è¦ï¼‰
- `val/optimal_precision` - ç²¾ç¡®ç‡
- `val/optimal_recall` - å¬å›ç‡
- `val/auprc` - å¹³å‡ç²¾ç¡®ç‡-å¬å›ç‡æ›²çº¿ä¸‹é¢ç§¯

---

## å…³é”®é…ç½®å‚æ•°é€ŸæŸ¥è¡¨

| å‚æ•° | å½“å‰å€¼ | ä½œç”¨ | è°ƒæ•´æ–¹å‘ |
|------|--------|------|----------|
| `focal_loss_alpha` | 0.85 | å¼‚å¸¸ç±»æƒé‡ | â†‘å‡å°‘è¯¯æŠ¥, â†“å‡å°‘æ¼æ£€ |
| `focal_loss_gamma` | 2.5 | éš¾æ ·æœ¬å…³æ³¨åº¦ | â†‘æ›´å…³æ³¨éš¾æ ·æœ¬ |
| `window_size` | 120 | è¾“å…¥åºåˆ—é•¿åº¦ | â†‘æ›´å¤šä¸Šä¸‹æ–‡, â†“æ›´å¿«è®­ç»ƒ |
| `target_anomaly_ratio` | 0.20 | è®­ç»ƒé›†å¼‚å¸¸æ¯”ä¾‹ | â†‘æé«˜å¬å›, â†“æé«˜ç²¾ç¡® |
| `learning_rate` | 0.0005 | å­¦ä¹ ç‡ | â†‘æ›´å¿«æ”¶æ•›ä½†ä¸ç¨³å®š |
| `dropout` | 0.2 | Dropoutæ¦‚ç‡ | â†‘å‡å°‘è¿‡æ‹Ÿåˆ, â†“å¢åŠ å®¹é‡ |
| `lstm_hidden_dim` | 256 | LSTMéšè—å±‚ | â†‘å¢åŠ å®¹é‡ |

---

## é¢„æœŸæ”¹è¿›

ä½¿ç”¨ä¼˜åŒ–åçš„é…ç½®ï¼Œæ‚¨åº”è¯¥èƒ½çœ‹åˆ°ï¼š

âœ… **Precision** ä» 0.11 æå‡åˆ° **0.3-0.5**ï¼ˆè¯¯æŠ¥å¤§å¹…å‡å°‘ï¼‰  
âœ… **Recall** ä» 0.52 æå‡åˆ° **0.6-0.8**ï¼ˆæ¼æ£€å‡å°‘ï¼‰  
âœ… **Adjusted F1** ä» 0.18 æå‡åˆ° **0.4-0.6**ï¼ˆæ€»ä½“æ€§èƒ½æ˜¾è‘—æå‡ï¼‰

**æ³¨æ„**ï¼šè¿™äº›æ˜¯åŸºäºç»éªŒçš„é¢„æœŸï¼Œå®é™…ç»“æœå–å†³äºæ•°æ®è´¨é‡å’Œç‰¹å¾ã€‚

---

## å¿«é€Ÿå¼€å§‹

```bash
# 1. æ¿€æ´»ç¯å¢ƒ
cd /home/wanting/energy_anomaly_detection
source venv/bin/activate

# 2. ä½¿ç”¨ä¼˜åŒ–é…ç½®å¼€å§‹è®­ç»ƒ
python src/training/lstm_cnn/train_lstm_cnn.py \
    --experiment_name lstm_cnn_optimized

# 3. åœ¨å¦ä¸€ä¸ªç»ˆç«¯ç›‘æ§è®­ç»ƒ
tensorboard --logdir experiments/lstm_cnn/tensorboard
```

ç¥è®­ç»ƒé¡ºåˆ©ï¼ğŸš€

